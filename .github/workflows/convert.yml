name: Convert Subscription

on:
  schedule:
    # 每天UTC时间00:00运行
    - cron: '0 0 * * *'

jobs:
  convert-subscription:
    runs-on: ubuntu-latest
        
    steps:
    # 步骤1: 检出代码仓库
    - name: Checkout Repository
      uses: actions/checkout@v2
    
    # 步骤2: 设置subconverter服务
    - name: Set up subconverter service
      run: |
        docker run -d --name subconverter -p 25500:25500 tindy2013/subconverter:latest
        sleep 5 # 确保服务有时间启动
    
    # 步骤3: 对订阅链接进行转换
    - name: Convert Subscription
      run: |
        SUBSCRIPTION_URL="http://dbpngo.xyz/xlvpn" # 将这里替换为你的实际订阅链接
        CONVERTED_SUBSCRIPTION=$(curl --silent --location --request GET "http://localhost:25500/sub?target=clash&url=${SUBSCRIPTION_URL}")
        echo "$CONVERTED_SUBSCRIPTION" > clash_subscription.yaml # 输出到文件中
    
    # 步骤4: 提交并推送更改
    - name: Commit files
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add -A
        git commit -m "Updated Clash subscription" -a
    
    - name: Push changes
      uses: ad-m/github-push-action@master
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        branch: 'master' # 替换为你的分支名称
        force: true
